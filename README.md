# sql_bible


## RDBMSの差

1. mysql(mariadb)はガラパゴス
リレーショナルDBのくせにjoinが遅く、
8.0系になるまで分析関数も、Withもサポートしていなかった。
sqlite以下の機能。

mysqlのアップデートの罠

update 
name = 
name2 = name2 * 3

としてみよう。

癖がありすぎる

自動コミットという罠


triggerに有効無効がない。

RDBMSについての誤解を受けやすいので、
初めてのRDBMSとしては不向き。
また、しっかりとデータの管理をしたいなら、
PG,SE側が管理しないといけない事が多く、管理コストは高い。
しかし、phpのフルスタックフレームワークは
mysql以外あまりテストしてないのもあるため、phpを開発者が選択するならmysqlを
選択せざるをえない事も多い。

1. mysqlとmariadb
そもそもサンプルでさえ動かない。
お互い別の道を歩き始めているので、mysqlの代替として
mariadbは既に危険。

1. mysql, mariadbはかなり標準sqlをガン無視した作りのため、
他のRDBMS経験者は、必ずmysql, mariadbで思ったように動くか
確認する事。

sqlserver
マルチバイト文字がCOBOL式。

azure data studioなどGUIのツールはメジャーなRDBMS
の中では一番使いやすく、いい意味で直感的に使える。

認証周りがカオス
Windows認証にする？sqlserver認証にする？

商用DBにしてはインストールが簡単。
で練習のためつまづくことは他の商用DBよりは少ないだろう。

ストアドはメジャーなRDBMSの中では一番書きやすい。

Windows版とLinux版があるが、Windows版でしか
使えない機能があったりする。
powershellから使うためのツールをMSが出しているので
それを使うと良い。


oracle
MSに比べてGUIのツールが重く、使い勝手が悪い。
これはoracleの能力不足というよりMSのGUIに関するノウハウがすごいということだろう。
vscodeがelectronを使っているにもかかわらず異様に軽く使いやすいのはネット記事でも称賛されていた。

商用DBの中ではインストールの難易度は高い。
コミュニティ版だと最大10GBまでしかDBを作れない。
oracle linuxにインストールするなら簡単だが、rhelにインストールしたり、
サポートされていないが、fedora, centosにインストールしようとすると自分で考える必要がある。
oracle listnerなど独自の考え方も多いのでインストールにつまづく可能性はある。

一度インストールできてしまえば、つまづくところは少ないだろう。

oracleの仕組みを参考にしているRDBMSは多いので、
oracleの知識をつけておくと他のRDBMSを触る時にも役に立つ。

sqlplusが使いづらかったり、痒いところに手が届かないのが
問題。
sqlplusでバッチ処理を描くより、pythonやgolangで描く方が
簡単かつ管理が楽だと思う。

日本ではosqleditという非公式のツールが幅を利かせているが、
日本でしか使われていないので、問題があった時困ると思うが...

エディタに関しては
vscodeにあるoracleのextensionを使うことをお勧めする。


DB2
商用DBの中ではインストールの難易度は真ん中ぐらい。
IBMのRDBMS。oracleよりライセンスが安く、
コミュニティ版だと無料で使える。

RDBMSに関してはoracleよりも新しい技術を取り入れていることもあるらしい。
銀行など金融系のシステムに向く。
メジャーなRDBMSの中では唯一律儀に
CREATE CATALOGという
標準SQLに従っている。
これはCREATE DATABASEのことであり、
IBMだけが変わった呼び方をしているのではなく、
RDBMSでDB2だけが律儀に
CREATE CATALOGという構文を実装しているのだ。
CREATE CATALOGがCREATE DATABASEのエイリアスだったり。



## ストアドファンクション

1. そもそもRDBMSを提供する側の温度感を見ておく。

oracleは

1. 無駄なループや、描きがち

2. デバッグがムズイ。

3. メモリを増やすだけでいいので問題の切り分けが楽。

4. 総合的にはselectする値を加工する、
計算用の

5. 

メリット
apiサーバー, webサーバー, スマホなど端末側と複数の場所で値の加工処理があると
面倒であり、
加工するという処理においてはメリットは昔よりもむしろ上がっていると思う。
全体としての計算処理のコストを抑えられる。

デメリット
jsdocなど決まった形式のコメントがない。
vscodeなどのエディタのインテリセンスが賢くない。
oracle, mysqlなどはストアドが貧弱かつ書き方に癖が強い。
sqlが前提として書ける必要がある。
よって要求されるスキルが高い。
oracleは一番ネットに例が多くoracle社員のブログやコラムはかなり参考になる。

## サロゲートキー

- サロゲートキーとは?

- 害がないは嘘。

そのサロゲートキーupsertの時に邪魔になりませんか？

- 規模が大きくなるにつれて邪魔になってくる。

- サロゲートキー以外にプライマリーになりうるキーがなかったら良い。

## 木構造データ

- 再起クエリ

- 区切り文字データ

98, 78, 32, ...
というふうにする。

- グラフDBの採用も考える
一日の最初に変化部分だけmergeなど。

## テーブル名が長いからとASで置き換えない

user AS uとかやると
grep するときに困ります。
原因を探す時はなるべくたくさん検索に引っかかった方が良いので。

## Null

- 意味

そこにデータが無いと言う意味。

- unknown
true, false, unknownで3値

- 空文字とNull
Oracleだと"" == Null
でもtrueになるが、これはOracleも
あまり良い動きでないと思っているので、いつ動かなくなるかわからない。

- 統計処理

よくあるミス
NULLを0としてはいけない。
NULLはそこにデータが無いという意味なので、

```sql
select *
from blood
GROUP BY 

```

- そもそもGROUP BYの意味とは



## 複合キー

1. Ormマッパーとの相性は悪い。

2. 使い所

1. ユーザーごと~などの集計結果のテーブルに向く。

1. 200x年mm月のユーザーが支払ったかどうか？

書く月に対して複数請求書がありうるなら
ユーザーid, 月,
書く月に対してm、各個人ごとの請求書など
ユーザーid, 月

## 集計の罠

その計算、スクリプト言語なら誤差できませんか？

1. 運送量システムなどは小数点以下の金額が出る事も多い。

2. 消費税。

1. 1にならず0.999999になる言語

2. 計算をsqlに寄せると早い上にあまり考えなくて良い。

3. 

## 

## トリガー


1. 管理画面と連動させてリレーションを解除など
2. triggerが管理上気づかないということがないように

## バッチ処理

### シェルスクリプト

シェルスクリプトは長くなると
管理が大変なので、

- bash
バックアップ、S3やファイルサーバーなど保存用のサーバーにアップロード
保存用のサーバーから開発サーバーに適用など
プログラミング言語側で書いてもそんなに楽にならないものなどに
使うべきである。
大規模な事業なら
ログやDBの保存期間は3ヶ月、　半年など決まっていて、
容量節約のためバックアップを削除することも多い。
(最近新たにできたプロジェクトならとりあえず全て残す事も多い)

- powershell
手動でやってもオペミスが生じづらいのは素晴らしい。
Windowsで仕事している人なら必須のスキル。
しかし、Linuxの資産とは相性が悪い...

### プログラミング言語

- golang
かなりシナジーが強い。型があるので曖昧なところが少なく、
オペミスする前に開発環境でミスを弾くことも容易。
Javaと比べてメモリの使用量がかなり低く、速度はJavaに匹敵する。
集計処理やデータ連携などで大量データを日時処理のバッチで動かすには
これが一番向くと思われる。
日本ではエンジニアの単価は一番高いのでそれがネックで採用を見送る事もあり。

- python
サクッと書けるが中規模以上でデータが何千行を毎日9時までに処理
みたいだと辛い可能性あり。
月次処理なら毎月どの程度のスピードでデータが増えているか？
サブスクリプションビジネスなら会員数の変化率を見て考えよう。

また、運搬費など小数点以下の処理が多発するなら根本的に向いてない。
pythonは自然化学とともに成長してきた言語だからか、
油断すると0.99999...という数字を簡単にだすぞ！

- Java
既にJavaの資産があるならアリ。またOracleを使っているかどうかも。
バッチ処理という点のみでいうとそれ以外はgolangの劣化になりやすい。すでにJavaの資産があるか、最近のプロジェクトでないものにはよく使われる。作業しているエンジニアに還元されるかどうかは置いといて、実はエンジニアの単価高い。

- csharp
charpは初期化に時間がかかるため、コンパイル言語の中ではバッチに向いていないと思う。ゲーム系ならありかも？それ以外はJavaと同じ。

- rust
rustに興味ある人でバッチ処理やDB処理に興味ある人がどれだけいるか...
今興味ある人は割とミーハーな人が多いので、こういう地味な処理は
ライブラリに信用もてるようになるまで時間かかりそう。
暗号資産とか組み込みとかネットワークならありかも?

## 統計処理

大学2, 3年までに習うレベルの統計をsqlで表現してみる。
なお、本格的に統計をやるならpythonの導入も検討すべきだが、
速度的な理由や環境にプログラミング言語をあまり増やしたくないなら
ありかと。

oracleがよく使われるためか、統計用の関数がたくさん定義されている。
データサイエンティストなら必須か。


```mysql

```

```postgresql

```

### カーネル関数

### 2項分布

### ポアソン分布

- mariadb

- postgresql

自分で用意する必要がある。

```postgresql
$$ DO function poisson() {

}

```

- oracle

ポアソン分布を使うための関数がすでに用意されている。


```oracle
poisson(項数, 平均)
```

- sqlserver

### t分布

### カイの２乗検定

## 木構造

### 特に理由がない場合は閉包モデル


- ビジネス的に表現が求めれらるもの
  - ネットワークビジネスの組織図
ネットワークビジネスは最初の１年間が基本的に
最も変化率が大きい年になる。
営業マンの販促ツールとして使われる事が多い（ただし、勧誘時に組織図を見せるのは日本の法律的に違法）。
会員の状態(正常、退会状態, ), コミッションが発生するかどうか(コミッション対象、コミッション支払い済み、コミッション非対応), 何階層目か、本人から見て何番目か、入会日、退会日を画面で見せる必要がある。
ビジネスの立ち上げ時なら即時反映でいいと思うが、
規模が大きくなると、即時反映だと余計なコストがかかるため毎日定時で
会員テーブルから組織図テーブルを作り直し、それを見えるようにする
などの処理を実装するのが良いと思われる。

- 大規模システムの組織図
(病院、コングロマリットの組織図など)

大抵の場合SQLのスキルが足りてない。
即時反映はまず求められず、ここの画面がどうしても遅いなら、
組織改変が行われた場合は厄介になる可能性がある。
権限マスタと外部キー制約をつけると
組織改変の場合に変更や管理で混乱が発生する可能性がある。
大病院などは年に一回大きな組織改変が行われる事は
ザラなので、外部キー制約の代わりに
insert, updateトリガーで管理するという方法を取るのもよい。
外部キー的にエラーならsqlの実行を止めるという処理にする。
組織改変でどうしても外部キーが変わる場合は
トリガーを無効にし、変わらない場合はや平常時は有効にするのだ。
こうすると余分な管理コストが減る。

- 権限マスタ
大規模システムで
一般に即時反映が求められる。

- オブジェクトストレージ
バイナリでデータを持たせる、またはパス
オブジェクトストレージを実装するという要件なら、
セキュリティ上、パスでなくて、バイナリでデータを持たせるという事が
一般かと思われる。

バイナリでデータを管理する場合は、他のRDBMSに
移行する場合に苦労する可能性がある。

wordpressのようにどうせ公開する動画、画像や
見られてもいいファイルばかり管理しているなら、
パスで管理するのも可能。

画面上で見える事

クラウドサービスのS3,azure storage, cloud buged
などの作りを参考にすると良い。


- 階層の数
親、子、孫までで終わっているなら
RDBMSだけ使ったら良い。

- グラフデータベース

- バッチ処理

  - 即時性が特に求められない場合に有効。
毎日5時など決まった時間に
組織図を作る直す処理を走らせる。
もしこの運用をするなら特に定期的にバキュームを実行する必要がある。
あまり考えたくない、管理コスト的に無理そうなら自動バキュームがあるpostgresqlを採用すること。

## トリガーの使い所

- 外部キー制約
一時的に有効、無効にしたい外部キー制約に使える。
外部キー制約を外したい時にトリガーを無効にして、
外部キー制約をかける列にインデックスを作っておけば良い。

下記に組織テーブルと職員テーブル

```sql
CREATE 
```

ただし、MySql, MariaDBでは特定のトリガーを無効にする事が
できないので、一度削除するかもしくは、triggerの有効無効という
テーブルを下のように設計して、その値を変更することにより管理する事。

```sql
CREATE TABLE trigger_status (

);

CREATE TRIGGER 
SELECT 
```

- 画面からの削除対応

データの一貫性を保つもの以外は落ちてもビジネス的に困らないものに使う。

- 通知に使う

oracleなら最初から備わっている。
mailを送信する

slackなどに送信
twilioなどに送信

slackapi key

lineに送信

afterのtriggerだけ。
新しいのが指定のときより少なかったら発注して欲しい。

KBのリッジベース


## 生成カラム

生成カラムとは
いわば、関数を新たに


- 半角カナ
半角カナは実をいうとサポートしなくて良い文字なので、
サポートしなくて良いかをまず考える必要がある。
iosや、Androidを見て欲しい。
半角カナはデフォルトだと入力できない事が多いと思われる。



- json
ドキュメントベースのDBを導入するまでもない時によく使われる。
データとして入れると検索時に困る事が多いので、動的に作成するのは
ありかと。

- url生成

衝突しないようにuuidを使ったりするとよい。

## CROSS JOIN

使い所がわからない人も多いと思うので、ここに記す。
これを知らないからと言って何かができないなどはないだろうが、
全体のチューニングには必要。

- 正負の絶対値で意味を持つデータ

例えば帳票データの場合
貸方と借方は常にイコールなので

INSERT into paymentbooks 
SELECT *
FROM CROSS JOIN (-1)
;
知らないと2回同じようなクエリを打つ事になる。
ため2倍近く速度差が出るという事。

- テスト用データ大量作成

単純に組み合わせの数だけ作られる。
これはプログラミング言語側のツールの方が楽な事も多い。

```sql
SELECT 1
```

- 

## UPSERT

これが楽かどうかは設計がしょぼいかどうかが如実に出る。

## 再起クエリ

## マテリアライズビュー

## View

結果が保存されるわけでなく、
Viewのクエリを実行した後にクエリが実行される。
現在はあまりメリットがない。

- 運用管理
よく使う長いSQL

- 

## ストアドプロシージャ

あまり使う事はおすすめしない。
プログラミングスキルが如実に出るため、管理コストが高い。
Oracleなど最近はストアドプロシージャにあまり興味がないところが多い。

エラーで落ちても、運用上別に問題にならないものに使うと良い。

- 一時テーブル、計算用テーブルの処理

あなたは外部システムから決済情報がcsvで送られてくる。
それをユーザーテーブル、決済テーブルに反映させる。

大規模開発かつSIER系で運用フェーズだと、
テーブルやストアドの作成、変更権限が他社にある事があり、
これを手動でやっているところも多いと思う。
異常な値があるときだけ、エラーで止まって、それ以外は
何も考えずにデータを入れてくる作りだと楽だ。

select *
from 
where customer_id in (
    1079
    ,333

)

これを
crontab -e


## バッチ処理

RDBMS

- 売り上げレポート作成

csvだけ欲しい時と
レポートも欲しい時と両方ある。

レポートを作るならRの方が楽だが、
バッチとの相性からpythonを選択しよう。
anaconda 

pip3 install scipy

```python
Fire

```

- 
